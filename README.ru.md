# Автоматизация экспорта DHCP из NetBox

Этот проект предоставляет настройку для автоматического экспорта статических привязок DHCP из [NetBox](https://github.com/netbox-community/netbox) для использования с сервером ISC DHCP, обеспечивая последовательные и актуальные соответствия.

#### Обзор

Скрипт (`netbox-export-dhcp.py`) получает статические привязки MAC-IP адресов из NetBox (для устройств и виртуальных сущностей) и обновляет локальный конфигурационный файл DHCP. Он предназначен для работы как служба systemd, периодически проверяя обновления привязок DHCP и перезагружая сервер DHCP, если обнаружены какие-либо изменения.

#### Файлы проекта

1. **`netbox-export-dhcp.py`**
   - **Назначение**: Основной скрипт на Python для получения резервирования DHCP из NetBox.
   - **Функциональность**:
     - Подключается к NetBox с использованием REST API и API токена.
     - Извлекает привязки IP-адресов, предназначенные для DHCP.
     - Безопасно записывает записи DHCP в локальный конфигурационный файл. Если обнаружены изменения в любом из конфигурационных файлов, перезагружает службу DHCP.
     - Записывает события через `syslog`.

2. **`netbox-export-dhcp.service`**
   - **Назначение**: Файл службы systemd для автоматизации выполнения скрипта.
   - **Функциональность**:
     - Определяет `simple` службу, которая запускает скрипт Python при старте.
     - Перезапускается, если возникают проблемы, с задержкой в 5 секунд между перезапусками.

3. **`netbox-export-dhcp.template`**
   - **Назначение**: Шаблон экспорта NetBox для привязок DHCP.
   - **Функциональность**:
     - Использует синтаксис Jinja2 для форматирования вывода как конфигурационного файла ISC DHCPD.
     - Записи вывода включают сгенерированное последовательно имя хоста, MAC-адрес и IP-адрес. Имя устройства добавляется как комментарий в конце строки для отладки.

4. **`configuration_example.py`**
   - **Назначение**: Пример конфигурационного файла.
   - **Параметры конфигурации**:
     - `NETBOX_API_URL`: URL экземпляра NetBox.
     - `NETBOX_API_TOKEN`: API токен для доступа к NetBox.
     - `OUTFILE`: Имя выходного файла для конфигураций DHCP.
     - `CONFDIR`: Директория, где хранится конфигурация DHCP (например, `/etc/dhcp`).

#### Установка и использование

1. **Требования**:
   - Клонируйте этот репозиторий.
   - Установите пакеты: 
   ```bash
   dnf install dhcp-server python3-requests
   ```

2. **Настройка DHCP сервера**:
   - Включите сгенерированные хосты в `dhcpd.conf`, добавив следующую строку:
   ```bash
   include "/etc/dhcp/dhcpd-netbox-hosts.conf";
   ```

3. **Настройка NetBox**:
   - Добавьте шаблон в NetBox, в разделе **Настройка** / **Экспорт шаблонов**.
   - Обязательные поля:
     - **Имя**: `dhcp_v1` (точно так).
     - **Типы объектов**: `IPAM > IP Address`.
     - **Код шаблона**: Вставьте содержимое `netbox-export-dhcp.template`.
     - **Расширение файла**: `.txt`.

   Проверьте свои настройки в NetBox: перейдите в **IPAM**, **IP адреса**, нажмите кнопку **Экспорт**, выберите `dhcp_v1`. Вы должны увидеть настроенные адреса, построчно.

4. **Настройка конфигурации**:
   - Скопируйте `configuration_example.py` в `configuration.py`.
   - Обновите `configuration.py` с вашими данными API NetBox, путем выходного файла и директории конфигурации DHCP.

5. **Тестирование настройки**:
   - Запустите скрипт вручную:
   ```bash
   python netbox-export-dhcp.py
   ```
   - Он должен вывести количество настроенных привязок. Завершите с помощью **Ctrl-C**.

6. **Установите службу Systemd**:
   - Поместите `netbox-export-dhcp.service` в `/etc/systemd/system/`.
   - Включите и запустите службу:
   ```bash
   sudo systemctl enable netbox-export-dhcp
   sudo systemctl start netbox-export-dhcp
   ```


#### Журналирование и мониторинг

Журналы направляются в `syslog` для мониторинга. Просматривайте журналы с помощью:
```bash
journalctl -u netbox-export-dhcp
```

#### Предварительные требования

- **Python** и библиотеки: Убедитесь, что установлены необходимые библиотеки Python (например, `requests` для HTTP-запросов).
- **DHCP сервер**: Служба DHCP, совместимая с сгенерированными конфигурациями (например, `dhcpd`).
- **NetBox**: Убедитесь, что доступ к API настроен и доступны необходимые IP-распределения.

#### Устранение неполадок

- **Ошибки конфигурации**: Проверьте параметры в `configuration.py`.
- **Сбои службы**: Проверьте журналы на наличие подробностей, особенно для проблем с подключением к NetBox или неправильными путями к файлам.